1. Conexão com o MongoDB
Estabelece uma conexão reutilizável com o banco.
Acessa três coleções:
tickets: onde os dados dos chamados são armazenados.
status: onde o status local de cada chamado é registrado.
importErr: onde erros de importação são logados.
2. Criação de índices
Garante que cada coleção tenha índice único baseado no id do ticket, evitando duplicações.
3. Busca do ticket mais recente
Consulta a API do Freshdesk para obter o ticket mais novo.
Usa esse id como ponto de partida para buscar tickets anteriores em ordem decrescente.
4. Loop de sincronização
Executa até 1000 requisições ou até que o ticketId chegue a zero.
Para cada ticket:
Verifica o status local (se validateStatus estiver ativado):
Se o ticket estiver marcado como "Encerrado", ele é ignorado.
Consulta o ticket na API do Freshdesk.
Se estiver próximo do limite de requisições, aguarda.
Se houver erro ou limite excedido, registra no MongoDB e pula para o próximo.
Determina o status do ticket:
"Encerrado" se o status for 4 ou 5.
"Aberto-Pendente" caso contrário.
Atualiza o status no MongoDB (se habilitado).
Se o ticket estiver encerrado, pula.
Se estiver aberto, também pode pular dependendo da lógica.
Busca as conversas associadas ao ticket.
Insere o ticket completo no MongoDB, incluindo conversas.
Se já existir, ignora (evita duplicação).
Se houver erro, registra em importErr.
5. Finalização
Exibe no log o número de requisições feitas e tickets inseridos.
Retorna um resumo com sucesso ou erro.
